<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZTP åŠ å¯†å™¨ - æ–°å¹´ç‰ˆ</title>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://unpkg.com/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
  --bg: #fff0f0;
  --card: #ffffff;
  --text: #222;
  --muted: #666;
  --border: #ffcccc;
  --main: #d92c2c;
  --progress: #ffd6d6;
}
html.dark {
  --bg: #1a1111;
  --card: #2c1a1a;
  --text: #f0f0f0;
  --muted: #ccc;
  --border: #552a2a;
  --main: #b32424;
  --progress: #442222;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: system-ui, sans-serif;
}
body {
  background: var(--bg);
  color: var(--text);
  padding: 20px;
  max-width: 500px;
  margin: 0 auto;
  transition: all 0.3s;
}
.card {
  background: var(--card);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.title {
  font-size: 18px;
  font-weight: 700;
  color: var(--main);
  margin-bottom: 12px;
}
.area {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 28px 10px;
  text-align: center;
  color: var(--muted);
  margin-bottom: 12px;
  cursor: pointer;
}
.area input {
  display: none;
}
.btn {
  background: var(--main);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 12px;
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  margin-top: 6px;
  cursor: pointer;
}
.pwd {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: transparent;
  color: var(--text);
  margin-bottom: 10px;
  outline: none;
}
.progress {
  height: 6px;
  background: var(--progress);
  border-radius: 3px;
  overflow: hidden;
  margin: 10px 0;
}
.bar {
  height: 100%;
  background: var(--main);
  width: 0;
  transition: width 0.2s;
}
.status {
  font-size: 14px;
  color: var(--muted);
}
.themeBtn {
  background: var(--card);
  color: var(--main);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 12px;
}
.row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}
</style>
</head>
<body>

<button class="themeBtn" id="toggleTheme">åˆ‡æ¢æš—è‰²/äº®è‰²</button>

<div class="card">
  <div class="title">ğŸ§§ æ–°å¹´ç‰ˆ ZTP åŠ å¯†å™¨</div>

  <div class="row">
    <input type="checkbox" id="usePassword">
    <label for="usePassword">ä½¿ç”¨å¯†ç åŠ å¯†</label>
  </div>

  <input class="pwd" id="zipPwd" placeholder="è®¾ç½®å¯†ç ï¼ˆå¯é€‰ï¼‰" type="password">

  <!-- è‡ªå®šä¹‰æ–‡ä»¶åè¾“å…¥æ¡† -->
  <input class="pwd" id="fileName" placeholder="è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆå¯é€‰ï¼Œæ— éœ€è¾“.ztpï¼‰">

  <div class="area" id="zipArea">
    <p id="zipText">é€‰æ‹©æ–‡ä»¶ / æ–‡ä»¶å¤¹</p>
    <input type="file" id="zipFiles" multiple webkitdirectory directory>
  </div>

  <button class="btn" id="doZip">ç”Ÿæˆ .ztp åŠ å¯†åŒ…</button>
  <div class="progress"><div class="bar" id="zipBar"></div></div>
  <div class="status" id="zipLog"></div>
</div>

<div class="card">
  <div class="title">ğŸ“‚ è§£å¯†è§£å‹</div>
  <input class="pwd" id="unzipPwd" placeholder="è¾“å…¥å¯†ç ï¼ˆå¦‚æœ‰ï¼‰" type="password">
  <div class="area" id="unzipArea">
    <p id="unzipText">é€‰æ‹© .ztp æ–‡ä»¶</p>
    <input type="file" id="unzipFile" accept=".ztp">
  </div>
  <button class="btn" id="doUnzip">è§£å¯†å¹¶è§£å‹</button>
  <div class="progress"><div class="bar" id="unzipBar"></div></div>
  <div class="status" id="unzipLog"></div>
</div>

<script>
const MAGIC = "ZTPv2-ZETA";
const XOR_KEY = 0x9D;

// æš—è‰²è®°å¿†
function loadTheme() {
  const dark = localStorage.getItem("dark") === "1";
  if (dark) document.documentElement.classList.add("dark");
}
function toggleDark() {
  const isDark = document.documentElement.classList.toggle("dark");
  localStorage.setItem("dark", isDark ? "1" : "0");
}
loadTheme();
document.getElementById("toggleTheme").onclick = toggleDark;

// é€‰æ‹©æ–‡ä»¶æ˜¾ç¤ºåç§°
document.getElementById("zipFiles").addEventListener("change", () => {
  const f = document.getElementById("zipFiles");
  document.getElementById("zipText").textContent =
    f.files.length ? `å·²é€‰ï¼š${f.files.length} é¡¹` : "é€‰æ‹©æ–‡ä»¶ / æ–‡ä»¶å¤¹";
});

document.getElementById("unzipFile").addEventListener("change", () => {
  const f = document.getElementById("unzipFile");
  document.getElementById("unzipText").textContent =
    f.files[0] ? `å·²é€‰ï¼š${f.files[0].name}` : "é€‰æ‹© .ztp æ–‡ä»¶";
});

function setBar(id, v) {
  document.getElementById(id).style.width = Math.min(100, v) + "%";
}
function xorBuf(buf, key) {
  const u = new Uint8Array(buf);
  for (let i=0; i<u.length; i++) u[i] ^= key;
  return u;
}
function aesEncrypt(data, pwd) {
  return CryptoJS.AES.encrypt(CryptoJS.lib.WordArray.create(data), pwd).toString();
}
function aesDecrypt(b64, pwd) {
  try {
    const d = CryptoJS.AES.decrypt(b64, pwd);
    return new Uint8Array(Array.from(d.words).flatMap(w => [
      (w >>> 24) & 0xff, (w >>> 16) & 0xff,
      (w >>> 8) & 0xff, w & 0xff
    ]));
  } catch {
    throw new Error("å¯†ç é”™è¯¯");
  }
}

// ç”Ÿæˆ ZTP
document.getElementById("doZip").onclick = async () => {
  const files = Array.from(document.getElementById("zipFiles").files);
  const usePwd = document.getElementById("usePassword").checked;
  const pwd = document.getElementById("zipPwd").value.trim();
  const fileNameInput = document.getElementById("fileName").value.trim();
  const log = document.getElementById("zipLog");

  if (files.length === 0) {
    log.textContent = "è¯·é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹";
    return;
  }

  if (usePwd && pwd === "") {
    log.textContent = "âŒ è¯·è¾“å…¥å¯†ç ";
    setBar("zipBar", 0);
    return;
  }

  log.textContent = "æ‰“åŒ…ä¸­...";
  setBar("zipBar", 20);

  const zip = new JSZip();
  files.forEach(f => {
    const path = f.webkitRelativePath || f.name;
    zip.file(path, f);
  });
  const bin = await zip.generateAsync({ type: "uint8array" });
  setBar("zipBar", 50);

  let finalData = bin;

  if (usePwd && pwd) {
    const aes = aesEncrypt(bin, pwd);
    finalData = xorBuf(new TextEncoder().encode(aes), XOR_KEY);
  }

  setBar("zipBar", 80);
  const head = new TextEncoder().encode(MAGIC);
  const out = new Uint8Array(head.length + finalData.length);
  out.set(head);
  out.set(finalData, head.length);

  // æ–‡ä»¶åé€»è¾‘ï¼šä¸å¡«ç”¨é»˜è®¤ï¼Œå¡«äº†å°±ç”¨ä½ çš„åå­— + .ztp
  let saveName = "archive.ztp";
  if (fileNameInput !== "") {
    saveName = fileNameInput.replace(/\.ztp$/i, "") + ".ztp";
  }

  saveAs(new Blob([out]), saveName);
  setBar("zipBar", 100);
  log.textContent = usePwd ? "âœ… å¸¦å¯†ç  ZTP å®Œæˆ" : "âœ… æ— å¯†ç  ZTP å®Œæˆ";
};

// è§£å‹
document.getElementById("doUnzip").onclick = async () => {
  const file = document.getElementById("unzipFile").files[0];
  const pwd = document.getElementById("unzipPwd").value.trim();
  const log = document.getElementById("unzipLog");

  if (!file) {
    log.textContent = "è¯·é€‰æ‹© .ztp æ–‡ä»¶";
    return;
  }

  log.textContent = "æ ¡éªŒä¸­...";
  setBar("unzipBar", 20);

  const buf = await file.arrayBuffer();
  const arr = new Uint8Array(buf);
  const magic = new TextDecoder().decode(arr.slice(0, MAGIC.length));

  if (magic !== MAGIC) {
    log.textContent = "âŒ é ZTP æ–‡ä»¶";
    return;
  }

  setBar("unzipBar", 40);
  const content = arr.slice(MAGIC.length);

  let bin;
  try {
    const xor = xorBuf(content, XOR_KEY);
    const b64 = new TextDecoder().decode(xor);
    bin = aesDecrypt(b64, pwd);
  } catch {
    bin = content;
  }

  setBar("unzipBar", 70);
  const zip = new JSZip();
  const z = await zip.loadAsync(bin);

  for (const name in z.files) {
    if (!z.files[name].dir) {
      const blob = await z.files[name].async("blob");
      saveAs(blob, name);
    }
  }

  setBar("unzipBar", 100);
  log.textContent = "âœ… è§£å‹å®Œæˆ";
};

document.getElementById("zipArea").onclick = () => document.getElementById("zipFiles").click();
document.getElementById("unzipArea").onclick = () => document.getElementById("unzipFile").click();
</script>
</body>
</html>
