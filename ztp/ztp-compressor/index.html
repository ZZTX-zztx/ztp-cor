<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZTP åŠ å¯†å™¨ - æ–°å¹´ç‰ˆ</title>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://unpkg.com/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
  --bg: #fff0f0;
  --card: #ffffff;
  --text: #222;
  --muted: #666;
  --border: #ffcccc;
  --main: #d92c2c;
  --progress: #ffd6d6;
}

html.dark {
  --bg: #1a1111;
  --card: #2c1a1a;
  --text: #f0f0f0;
  --muted: #ccc;
  --border: #552a2a;
  --main: #b32424;
  --progress: #442222;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: system-ui, sans-serif;
}

body {
  background: var(--bg);
  color: var(--text);
  padding: 20px;
  max-width: 500px;
  margin: 0 auto;
  transition: all 0.3s;
}

.card {
  background: var(--card);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.title {
  font-size: 18px;
  font-weight: 700;
  color: var(--main);
  margin-bottom: 12px;
}

.area {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 28px 10px;
  text-align: center;
  color: var(--muted);
  margin-bottom: 12px;
  cursor: pointer;
}

.area input {
  display: none;
}

.btn {
  background: var(--main);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 12px;
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  margin-top: 6px;
  cursor: pointer;
}

.pwd {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: transparent;
  color: var(--text);
  margin-bottom: 10px;
  outline: none;
}

.progress {
  height: 6px;
  background: var(--progress);
  border-radius: 3px;
  overflow: hidden;
  margin: 10px 0;
}

.bar {
  height: 100%;
  background: var(--main);
  width: 0;
  transition: width 0.2s;
}

.status {
  font-size: 14px;
  color: var(--muted);
}

.themeBtn {
  background: var(--card);
  color: var(--main);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 12px;
}

.row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}
</style>
</head>

<body>
<button class="themeBtn" id="toggleTheme">åˆ‡æ¢æš—è‰²/äº®è‰²</button>

<div class="card">
  <div class="title">ğŸ§§ æ–°å¹´ç‰ˆ ZTP åŠ å¯†å™¨</div>

  <div class="row">
    <input type="checkbox" id="useEncrypt" checked>
    <label for="useEncrypt">å¯ç”¨åŠ å¯†ï¼ˆç”Ÿæˆ .ztpï¼‰</label>
  </div>

  <input class="pwd" id="zipPwd" placeholder="è®¾ç½®åŠ å¯†å¯†ç " type="password">
  <div class="area" id="zipArea">
    <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
    <input type="file" id="zipFiles" multiple>
  </div>
  <button class="btn" id="doZip">ç”Ÿæˆæ–‡ä»¶</button>
  <div class="progress"><div class="bar" id="zipBar"></div></div>
  <div class="status" id="zipLog"></div>
</div>

<div class="card">
  <div class="title">ğŸ“‚ è§£å¯†è§£å‹</div>
  <input class="pwd" id="unzipPwd" placeholder="è¾“å…¥è§£å¯†å¯†ç " type="password">
  <div class="area" id="unzipArea">
    <p>é€‰æ‹© .ztp æ–‡ä»¶</p>
    <input type="file" id="unzipFile" accept=".ztp">
  </div>
  <button class="btn" id="doUnzip">è§£å¯†å¹¶è§£å‹</button>
  <div class="progress"><div class="bar" id="unzipBar"></div></div>
  <div class="status" id="unzipLog"></div>
</div>

<script>
const MAGIC = "ZTPv2-ZETA";
const XOR_KEY = 0x9D;
const DEFAULT_PWD = "123456";

// æš—è‰²æ¨¡å¼è®°å¿†
function loadTheme() {
  const dark = localStorage.getItem("dark") === "1";
  if (dark) document.documentElement.classList.add("dark");
}

function toggleDark() {
  const isDark = document.documentElement.classList.toggle("dark");
  localStorage.setItem("dark", isDark ? "1" : "0");
}

loadTheme();
document.getElementById("toggleTheme").onclick = toggleDark;

function setBar(id, v) {
  document.getElementById(id).style.width = Math.min(100, v) + "%";
}

function xorBuf(buf, key) {
  const u = new Uint8Array(buf);
  for (let i = 0; i < u.length; i++) u[i] ^= key;
  return u;
}

function aesEncrypt(data, pwd) {
  return CryptoJS.AES.encrypt(CryptoJS.lib.WordArray.create(data), pwd).toString();
}

function aesDecrypt(b64, pwd) {
  try {
    const d = CryptoJS.AES.decrypt(b64, pwd);
    return new Uint8Array(Array.from(d.words).flatMap(w => [
      (w >>> 24) & 0xff, (w >>> 16) & 0xff,
      (w >>> 8) & 0xff, w & 0xff
    ]));
  } catch {
    throw new Error("å¯†ç é”™è¯¯");
  }
}

document.getElementById("doZip").onclick = async () => {
  const files = Array.from(document.getElementById("zipFiles").files);
  const pwd = document.getElementById("zipPwd").value || DEFAULT_PWD;
  const useEncrypt = document.getElementById("useEncrypt").checked;
  const log = document.getElementById("zipLog");
  if (!files.length) return log.textContent = "è¯·é€‰æ‹©æ–‡ä»¶";
  log.textContent = "æ‰“åŒ…ä¸­...";
  setBar("zipBar", 20);

  const zip = new JSZip();
  files.forEach(f => zip.file(f.name, f));
  const bin = await zip.generateAsync({ type: "uint8array" });
  setBar("zipBar", 50);

  if (!useEncrypt) {
    saveAs(new Blob([bin]), "archive.zip");
    setBar("zipBar", 100);
    log.textContent = "âœ… æ‰“åŒ…å®Œæˆï¼ˆæ™®é€š ZIPï¼‰";
    return;
  }

  const aes = aesEncrypt(bin, pwd);
  const enc = xorBuf(new TextEncoder().encode(aes), XOR_KEY);
  setBar("zipBar", 80);

  const head = new TextEncoder().encode(MAGIC);
  const out = new Uint8Array(head.length + enc.length);
  out.set(head);
  out.set(enc, head.length);

  saveAs(new Blob([out]), "åŠ å¯†æ–‡ä»¶.ztp");
  setBar("zipBar", 100);
  log.textContent = "âœ… åŠ å¯†å®Œæˆï¼ˆZTPï¼‰";
};

document.getElementById("doUnzip").onclick = async () => {
  const file = document.getElementById("unzipFile").files[0];
  const pwd = document.getElementById("unzipPwd").value || DEFAULT_PWD;
  const log = document.getElementById("unzipLog");
  if (!file) return log.textContent = "è¯·é€‰æ‹© .ztp æ–‡ä»¶";
  log.textContent = "æ ¡éªŒä¸­...";
  setBar("unzipBar", 20);

  const buf = await file.arrayBuffer();
  const arr = new Uint8Array(buf);
  const magic = new TextDecoder().decode(arr.slice(0, MAGIC.length));
  if (magic !== MAGIC) return log.textContent = "âŒ ä¸æ˜¯åˆæ³• ZTP æ–‡ä»¶";

  setBar("unzipBar", 40);
  const data = xorBuf(arr.slice(MAGIC.length), XOR_KEY);
  const b64 = new TextDecoder().decode(data);

  let bin;
  try {
    bin = aesDecrypt(b64, pwd);
  } catch {
    log.textContent = "âŒ å¯†ç é”™è¯¯";
    return;
  }

  setBar("unzipBar", 70);
  const zip = new JSZip();
  const z = await zip.loadAsync(bin);
  for (const name in z.files) {
    if (!z.files[name].dir) {
      const blob = await z.files[name].async("blob");
      saveAs(blob, name);
    }
  }
  setBar("unzipBar", 100);
  log.textContent = "âœ… è§£å¯†å®Œæˆ";
};

document.getElementById("zipArea").onclick = () => document.getElementById("zipFiles").click();
document.getElementById("unzipArea").onclick = () => document.getElementById("unzipFile").click();
</script>
</body>
</html>
