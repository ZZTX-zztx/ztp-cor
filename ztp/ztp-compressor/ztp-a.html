<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZTP å‹ç¼©å™¨</title>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://unpkg.com/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {
  --bg: #fff0f0;
  --card: #ffffff;
  --text: #222;
  --muted: #666;
  --border: #ffcccc;
  --main: #d92c2c;
  --progress: #ffd6d6;
}
html.dark {
  --bg: #1a1111;
  --card: #2c1a1a;
  --text: #f0f0f0;
  --muted: #ccc;
  --border: #552a2a;
  --main: #b32424;
  --progress: #442222;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: system-ui, sans-serif;
}
body {
  background: var(--bg);
  color: var(--text);
  padding: 20px;
  max-width: 500px;
  margin: 0 auto;
  transition: all 0.3s;
}
.card {
  background: var(--card);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.title {
  font-size: 18px;
  font-weight: 700;
  color: var(--main);
  margin-bottom: 12px;
}
.area {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 28px 10px;
  text-align: center;
  color: var(--muted);
  margin-bottom: 12px;
  cursor: pointer;
}
.area input {
  display: none;
}
.btn {
  background: var(--main);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 12px;
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  margin-top: 6px;
  cursor: pointer;
}
.input-box {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: transparent;
  color: var(--text);
  margin-bottom: 10px;
  outline: none;
}
.progress {
  height: 6px;
  background: var(--progress);
  border-radius: 3px;
  overflow: hidden;
  margin: 10px 0;
}
.bar {
  height: 100%;
  background: var(--main);
  width: 0;
  transition: width 0.2s;
}
.status {
  font-size: 14px;
  color: var(--muted);
  text-align: center;
}
.row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}
.themeBtn {
  background: var(--card);
  color: var(--main);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 12px;
}
</style>
</head>
<body>

<button class="themeBtn" id="toggleTheme">åˆ‡æ¢æš—è‰²/äº®è‰²</button>

<div class="card">
  <div class="title">ğŸ“¦ ZTP æ‰“åŒ…å™¨</div>

  <div class="row">
    <input type="checkbox" id="usePassword">
    <label>ä½¿ç”¨å¯†ç åŠ å¯†</label>
  </div>

  <input class="input-box" id="zipPwd" placeholder="è®¾ç½®å¯†ç " type="password">
  <input class="input-box" id="fileName" placeholder="è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰">

  <div class="area" id="zipArea">
    <p id="tipText">é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</p>
    <input type="file" id="fileInput" multiple webkitdirectory directory>
  </div>

  <button class="btn" id="doPack">ç”Ÿæˆ ZTP æ–‡ä»¶</button>
  <div class="progress"><div class="bar" id="progressBar"></div></div>
  <p class="status" id="status"></p>
</div>

<script>
const MAGIC = "ZTPv2-ZTP";
const XOR_KEY = 0x9D;

// ä¸»é¢˜è®°å¿†
function loadTheme() {
  if (localStorage.getItem("dark") === "1")
    document.documentElement.classList.add("dark");
}
function toggleDark() {
  const d = document.documentElement.classList.toggle("dark");
  localStorage.setItem("dark", d ? "1" : "0");
}
loadTheme();
document.getElementById("toggleTheme").onclick = toggleDark;

// é€‰æ‹©æ–‡ä»¶æ˜¾ç¤º
const inp = document.getElementById("fileInput");
inp.onchange = () => {
  document.getElementById("tipText").textContent =
    inp.files.length ? `å·²é€‰ ${inp.files.length} é¡¹` : "é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹";
};

// æ‰“åŒ…é€»è¾‘
document.getElementById("doPack").onclick = async () => {
  const files = Array.from(inp.files);
  const usePwd = document.getElementById("usePassword").checked;
  const pwd = document.getElementById("zipPwd").value.trim();
  const name = document.getElementById("fileName").value.trim();
  const st = document.getElementById("status");

  if (files.length === 0) {
    st.textContent = "è¯·å…ˆé€‰æ‹©æ–‡ä»¶";
    return;
  }
  if (usePwd && pwd === "") {
    st.textContent = "è¯·è¾“å…¥å¯†ç ";
    return;
  }

  st.textContent = "æ­£åœ¨æ‰“åŒ…...";
  document.getElementById("progressBar").style.width = "30%";

  const zip = new JSZip();
  files.forEach(f => zip.file(f.webkitRelativePath || f.name, f));
  const bin = await zip.generateAsync({ type: "uint8array" });

  document.getElementById("progressBar").style.width = "60%";

  let out = bin;
  if (usePwd) {
    const aes = CryptoJS.AES.encrypt(CryptoJS.lib.WordArray.create(bin), pwd).toString();
    out = new TextEncoder().encode(aes);
    out = out.map(b => b ^ XOR_KEY);
  }

  const head = new TextEncoder().encode(MAGIC);
  const buf = new Uint8Array(head.length + out.length);
  buf.set(head);
  buf.set(out, head.length);

  const saveName = (name || "archive") + ".ztp";
  saveAs(new Blob([buf]), saveName);

  document.getElementById("progressBar").style.width = "100%";
  st.textContent = "âœ… ç”Ÿæˆå®Œæˆï¼š" + saveName;
};

document.getElementById("zipArea").onclick = () => inp.click();
</script>
</body>
  </html>
