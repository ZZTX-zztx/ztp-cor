<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZTP è§£å‹å™¨</title>
<link rel="icon" href="./ztpU.ico" type="image/x-icon">
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://unpkg.com/crypto-js@4.2.0/crypto-js.min.js"></script>
<style>
:root {--bg:#fff0f0;--card:#fff;--text:#222;--muted:#666;--border:#ffcccc;--main:#d92c2c;--progress:#ffd6d6;}
html.dark {--bg:#1a1111;--card:#2c1a1a;--text:#f0f0f0;--muted:#ccc;--border:#552a2a;--main:#b32424;--progress:#442222;}
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif;}
body{background:var(--bg);color:var(--text);padding:20px;max-width:500px;margin:0 auto;}
.card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.title{font-size:18px;font-weight:700;color:var(--main);margin-bottom:12px;}
.area{border:2px dashed var(--border);border-radius:12px;padding:28px 10px;text-align:center;color:var(--muted);margin-bottom:12px;cursor:pointer;}
.area input{display:none;}
.btn{background:var(--main);color:#fff;border:none;border-radius:10px;padding:12px;width:100%;font-size:15px;font-weight:600;margin-top:6px;cursor:pointer;}
.input-box{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);margin-bottom:10px;outline:none;display:none;}
.progress{height:6px;background:var(--progress);border-radius:3px;overflow:hidden;margin:10px 0;}
.bar{height:100%;background:var(--main);width:0;transition:width 0.2s;}
.status{font-size:14px;color:var(--muted);text-align:center;}
.themeBtn{background:var(--card);color:var(--main);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:14px;cursor:pointer;margin-bottom:12px;}
</style>
</head>
<body>

<button class="themeBtn" id="toggleTheme">åˆ‡æ¢æš—è‰²/äº®è‰²</button>
<div class="card">
  <div class="title">ğŸ”“ ZTP è§£å‹å™¨</div>

  <input class="input-box" id="pwdInput" placeholder="è¯·è¾“å…¥è§£å¯†å¯†ç " type="password">

  <div class="area" id="dropArea">
    <p id="tipText">é€‰æ‹© .ztp æ–‡ä»¶</p>
    <input type="file" id="fileInput" accept=".ztp">
  </div>

  <button class="btn" id="startBtn">å¼€å§‹è§£å‹</button>
  <div class="progress"><div class="bar" id="progressBar"></div></div>
  <p class="status" id="status"></p>
</div>

<script>
const MAGIC = "ZTPv2-ZETA";
const XOR_KEY = 0x9D;

// ä¸»é¢˜
function loadTheme(){
  if(localStorage.getItem("dark")==="1") document.documentElement.classList.add("dark");
}
function toggleDark(){
  const d=document.documentElement.classList.toggle("dark");
  localStorage.setItem("dark",d?"1":"0");
}
loadTheme();
document.getElementById("toggleTheme").onclick=toggleDark;

const fileInput=document.getElementById("fileInput");
const pwdInput=document.getElementById("pwdInput");
const tipText=document.getElementById("tipText");
const startBtn=document.getElementById("startBtn");
const status=document.getElementById("status");
const progressBar=document.getElementById("progressBar");

let currentFile=null;
let needPwd=false;

// é€‰æ‹©æ–‡ä»¶åè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦å¯†ç 
fileInput.onchange=async ()=>{
  const file=fileInput.files[0];
  if(!file) return;
  currentFile=file;
  tipText.textContent="å·²é€‰æ‹©ï¼š"+file.name;
  status.textContent="æ­£åœ¨æ£€æµ‹æ–‡ä»¶ç±»å‹...";
  progressBar.style.width="30%";

  const buf=await file.arrayBuffer();
  const arr=new Uint8Array(buf);
  const magic=new TextDecoder().decode(arr.slice(0,MAGIC.length));

  if(magic!==MAGIC){
    status.textContent="âŒ ä¸æ˜¯åˆæ³• ZTP æ–‡ä»¶";
    progressBar.style.width="0";
    pwdInput.style.display="none";
    needPwd=false;
    return;
  }

  // åˆ¤æ–­æ˜¯å¦åŠ å¯†
  const content=arr.slice(MAGIC.length);
  try{
    const test=content.map(b=>b^XOR_KEY);
    const str=new TextDecoder().decode(test);
    if(str.startsWith("U2FsdGVkX1")){
      needPwd=true;
      pwdInput.style.display="block";
      status.textContent="âœ… è¯¥æ–‡ä»¶éœ€è¦å¯†ç ";
    }else{
      needPwd=false;
      pwdInput.style.display="none";
      status.textContent="âœ… è¯¥æ–‡ä»¶æ— éœ€å¯†ç ";
    }
  }catch{
    needPwd=false;
    pwdInput.style.display="none";
    status.textContent="âœ… è¯¥æ–‡ä»¶æ— éœ€å¯†ç ";
  }
  progressBar.style.width="100%";
};

// å¼€å§‹è§£å‹
startBtn.onclick=async ()=>{
  if(!currentFile){
    status.textContent="è¯·å…ˆé€‰æ‹© ztp æ–‡ä»¶";
    return;
  }
  if(needPwd && !pwdInput.value.trim()){
    status.textContent="è¯·è¾“å…¥å¯†ç ";
    return;
  }

  status.textContent="æ­£åœ¨è§£å‹...";
  progressBar.style.width="30%";
  const pwd=pwdInput.value.trim();

  try{
    const buf=await currentFile.arrayBuffer();
    const arr=new Uint8Array(buf);
    const magic=new TextDecoder().decode(arr.slice(0,MAGIC.length));
    if(magic!==MAGIC) throw "æ ¼å¼é”™è¯¯";

    let data=arr.slice(MAGIC.length);

    if(needPwd){
      data=data.map(b=>b^XOR_KEY);
      const b64=new TextDecoder().decode(data);
      const dec=CryptoJS.AES.decrypt(b64,pwd);
      const len=dec.sigBytes;
      const bin=new Uint8Array(len);
      for(let i=0;i<len;i++){
        bin[i]=(dec.words[i>>>2]>>>(8*(3-(i&3))))&0xff;
      }
      data=bin;
    }

    const zip=new JSZip();
    const z=await zip.loadAsync(data);
    progressBar.style.width="70%";

    for(const n in z.files){
      if(!z.files[n].dir){
        const blob=await z.files[n].async("blob");
        saveAs(blob,z.files[n].name);
      }
    }
    status.textContent="âœ… è§£å‹å®Œæˆï¼";
    progressBar.style.width="100%";
  }catch(e){
    status.textContent="âŒ è§£å‹å¤±è´¥ï¼šå¯†ç é”™è¯¯æˆ–æ–‡ä»¶æŸå";
    progressBar.style.width="0";
  }
};

document.getElementById("dropArea").onclick=()=>fileInput.click();
</script>
</body>
</html>
